version: '3.8'

services:
  # 1. PostgreSQL-Dienst (Datenbank)
  db:
    image: postgres:latest
    container_name: gout_db_container
    restart: always
    environment:
      POSTGRES_USER: gout_service
      POSTGRES_PASSWORD: tosh&123
      POSTGRES_DB: goutdiary
	  PGDATA: /var/lib/postgresql/data/
    volumes:
      # Host-Pfad zur Datenpersistenz
      - /volume1/docker/postgresql/data:/var/lib/postgresql/data
      # Host-Pfad zur Konfigurationsdatei
      #- ./config/pg_hba.conf:/var/lib/postgresql/data/pg_hba.conf
    ports:
      - "5433:5432"
  
  # 2. Node.js-Dienst (Anwendung)
  # WIR NUTZEN JETZT DAS FERTIGE IMAGE
  app:
    image: node:20 # Oder eine andere stabile Node-Version
    container_name: gout_node_app
    restart: always
    # Der Node-Container muss einen Befehl ausführen (z.B. um Abhängigkeiten zu installieren)
    # Wenn du ein Dockerfile hast, das dies erledigt, brauchst du 'command:' nicht.
    # Ansonsten:
    # command: bash -c "npm install && npm start" 
    ports:
      - "3001:3001"
    depends_on:
      - db
    volumes:
      # Host-Pfad deiner App: /volume1/docker/nodejs/goutdiary
      # CONTAINER-Pfad: /usr/src/app (Typisches Arbeitsverzeichnis)
      - /volume1/nodejs/goutdiary:/usr/src/app
    # Setze das Arbeitsverzeichnis, damit der 'command' dort ausgeführt wird
    working_dir: /usr/src/app
    environment:
      DATABASE_HOST: db 
      DATABASE_USER: gout_service
      DATABASE_PASSWORD: tosh&123
      DATABASE_NAME: goutdiary
      DATABASE_PORT: 5432 #Port der Datenbank in internem Netzwerk, exstern 5433

  # 3. pgAdmin-Dienst (Grafisches Interface)
  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin_server
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: dunker.thorsten@gmail.com
      PGADMIN_DEFAULT_PASSWORD: tosh&123
    ports:
      - "5050:80" 
    volumes:
      - /volume1/docker/postgresadmin:/var/lib/pgadmin
    depends_on:
      - db